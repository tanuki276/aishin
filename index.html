<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>noden</title>
  <style>
/* ... (ã‚¹ã‚¿ã‚¤ãƒ«ã‚³ãƒ¼ãƒ‰ã¯çœç•¥ã€‚å¤‰æ›´ãªã—) ... */
:root{
  --bg-1:#0f1724;
  --bg-2:#081325;
  --accent-1:#00e0ff;
  --accent-2:#ff4dd2;
  --glass: rgba(255,255,255,0.04);
  --muted: rgba(255,255,255,0.65);
}
/* ... (CSSã¯é•·ã„ã®ã§çœç•¥ã—ã¾ã™ãŒã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯æ®‹ã—ã¦ãã ã•ã„) ... */
/* Sidebar */
.sidebar{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px; padding:14px; display:flex;flex-direction:column;gap:12px;min-width:260px;height:100%;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.4);font-weight:700}
.brand h1{font-size:16px;margin:0}
.search{display:flex;gap:8px;align-items:center}
.input{background:var(--glass);border-radius:10px;padding:8px 10px;color:var(--muted);border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center}
.input input{background:transparent;border:0;outline:none;color:inherit;width:100%}
.conversations{flex:1;overflow:auto;padding-right:6px}
.conv{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;transition:background .18s, transform .12s}
.conv:hover{background:rgba(255,255,255,0.02);transform:translateY(-2px)}
.avatar{width:44px;height:44px;border-radius:10px;flex-shrink:0;background:linear-gradient(135deg,#fff2, #fff0);display:flex;align-items:center;justify-content:center;font-weight:700;color:#000}
.conv .meta{flex:1;min-width:0}
.conv .meta .title{font-weight:600}
.conv .meta .sub{font-size:12px;color:rgba(230,238,246,0.6);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
/* Chat panel */
.chat-panel{display:flex;flex-direction:column;height:100%;gap:12px}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
.h-left{display:flex;align-items:center;gap:12px}
.h-title{font-weight:700}
.h-actions{display:flex;gap:10px;align-items:center}
.icon-btn{width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .12s, background .12s}
.icon-btn:hover{transform:translateY(-3px);background:rgba(255,255,255,0.06)}
/* Messages area */
.messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px}
.message{
  max-width:72%;padding:12px 14px;border-radius:14px;position:relative;word-break:break-word;box-shadow:0 8px 24px rgba(2,6,23,0.5);
  transform-origin:bottom right;opacity:0;transform:translateY(8px) scale(.98);
  animation:fadeUp .35s ease forwards;
}
@keyframes fadeUp{to{opacity:1;transform:translateY(0) scale(1)}}
.msg-user{margin-left:auto;background:linear-gradient(135deg,var(--accent-1),#60f2a8);color:#042027;border-bottom-right-radius:6px}
.msg-bot{margin-right:auto;background:linear-gradient(135deg,#0b1226,transparent);border:1px solid rgba(255,255,255,0.03);color:var(--muted);border-bottom-left-radius:6px}
.msg-meta{font-size:11px;color:rgba(230,238,246,0.55);margin-top:6px;display:flex;gap:8px;align-items:center}
.msg-time{opacity:0.8}
/* Typing indicator */
.typing{display:inline-flex;gap:6px;align-items:center}
.typing .dot{width:8px;height:8px;border-radius:50%;background:var(--accent-1);opacity:0.2;animation:blink 1s infinite}
.typing .dot:nth-child(2){animation-delay:.15s}
.typing .dot:nth-child(3){animation-delay:.3s}
@keyframes blink{0%{opacity:0.15;transform:translateY(0)}50%{opacity:1;transform:translateY(-6px)}100%{opacity:0.15;transform:translateY(0)}}
/* Input area */
.composer{display:flex;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));align-items:flex-end}
.textarea{flex:1;position:relative}
textarea{width:100%;min-height:48px;max-height:160px;resize:none;padding:12px 14px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;outline:none;font-size:15px}
.row-actions{display:flex;flex-direction:column;gap:8px}
.send-btn{width:56px;height:56px;border-radius:999px;background:linear-gradient(135deg,var(--accent-2),var(--accent-1));display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.5);border:none;color:#061018;font-weight:700;transition:transform .15s}
.send-btn:hover{transform:translateY(-6px) rotate(-6deg)}
.send-btn:active{transform:scale(.98)}
.small{font-size:12px;color:rgba(230,238,246,0.7)}
/* Reaction bubble */
.reaction-palette{position:absolute;display:flex;gap:6px;padding:6px;background:linear-gradient(90deg, rgba(0,0,0,0.5), rgba(255,255,255,0.02));border-radius:999px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.reaction{padding:6px;border-radius:50%;cursor:pointer;transition:transform .12s}
.reaction:hover{transform:translateY(-4px)}
/* Status bar */
.status{display:flex;gap:10px;align-items:center}
.toggle{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,0.02);padding:6px;border-radius:10px}
/* helper */
.center{display:flex;align-items:center;justify-content:center}
.hint{font-size:13px;color:rgba(230,238,246,0.55)}
/* mobile tweaks */
@media(max-width:880px){.app{grid-template-columns:1fr;height:92vh}.sidebar{display:none}}
  </style>
</head>
<body>
<div class="app" role="application">
  <aside class="sidebar" aria-label="ä¼šè©±ä¸€è¦§">
    <div class="brand">
      <div class="logo">JSAI</div>
      <div>
        <h1>ç¥ãƒãƒ£ãƒƒãƒˆ Pro</h1>
        <div class="small">é€Ÿã„ãƒ»æ´¾æ‰‹ãƒ»æ°¸ç¶š</div>
      </div>
    </div>
    <div class="search">
      <div class="input" title="æ¤œç´¢">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.9"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
        <input id="conv-search" placeholder="æ¤œç´¢ or æ–°è¦ä½œæˆ" aria-label="ä¼šè©±æ¤œç´¢">
      </div>
    </div>

    <div class="conversations" id="conversations" role="list"></div>

    <div class="status">
      <div class="toggle" id="sound-toggle" title="é€ä¿¡éŸ³ã‚ªãƒ³/ã‚ªãƒ•">ğŸ”Š <span class="small">éŸ³</span></div>
      <div class="toggle" id="theme-toggle" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ— <span class="small">ãƒ†ãƒ¼ãƒ</span></div>
      <div class="hint" style="margin-left:auto">ä¿å­˜: localStorage</div>
    </div>

  </aside>

  <main class="chat-panel" aria-live="polite">
    <div class="header">
      <div class="h-left">
        <div class="h-title">noden</div>
        <div class="small">è‡ªä½œJSAI</div>
      </div>
      <div class="h-actions">
        <button class="icon-btn" id="clear-btn" title="ãƒãƒ£ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢">ğŸ—‘</button>
        <button class="icon-btn" id="export-btn" title="ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">â¬‡ï¸</button>
      </div>
    </div>

    <section class="messages" id="messages" aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§"></section>

    <form class="composer" id="composer" onsubmit="return false;">
      <div class="textarea">
        <textarea id="input" placeholder="Shift+Enterã§æ”¹è¡Œ â€” Enterã§é€ä¿¡" aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›"></textarea>
        <div style="position:absolute;right:12px;bottom:10px;display:flex;gap:8px;align-items:center">
          <button type="button" id="emoji-btn" class="icon-btn" title="çµµæ–‡å­—">ğŸ˜Š</button>
        </div>
      </div>
      <div class="row-actions">
        <button class="send-btn" id="send" title="é€ä¿¡" type="submit">â¤</button>
      </div>
    </form>

  </main>
</div>

<template id="reaction-template">
  <div class="reaction-palette">
    <div class="reaction">ğŸ‘</div>
    <div class="reaction">â¤ï¸</div>
    <div class="reaction">ğŸ”¥</div>
    <div class="reaction">ğŸ˜®</div>
    <div class="reaction">ğŸ˜‚</div>
  </div>
</template>

<script>
/**
 * ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—§ public/main.js ã®å†…å®¹ï¼‰
 * HTMLå†…ã«ç›´æ¥åŸ‹ã‚è¾¼ã¿ã€å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«å‚ç…§ã®å•é¡Œã‚’è§£æ¶ˆ
 */

// UIè¦ç´ ã®å–å¾—
const messagesContainer = document.getElementById('messages');
const inputElement = document.getElementById('input');
const composerForm = document.getElementById('composer');
const sendButton = document.getElementById('send');
const clearButton = document.getElementById('clear-btn');

// ===================================
// 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// ===================================

/**
 * æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DOMã«è¿½åŠ ã—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã«ã™ã‚‹
 * @param {string} text - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
 * @param {string} senderClass - 'msg-user' ã¾ãŸã¯ 'msg-bot'
 */
function displayMessage(text, senderClass) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${senderClass}`;
    
    const content = document.createElement('p');
    content.textContent = text; 
    
    const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    const metaDiv = document.createElement('div');
    metaDiv.className = 'msg-meta';
    metaDiv.innerHTML = `<span class="msg-time">${time}</span>`;

    messageDiv.appendChild(content);
    messageDiv.appendChild(metaDiv);
    messagesContainer.appendChild(messageDiv);

    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


// ===================================
// 2. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç† (æ©Ÿèƒ½æ”¹å–„: APIã‚¨ãƒ©ãƒ¼ã‚’ã‚ˆã‚Šæ˜ç¢ºã«è¡¨ç¤º)
// ===================================

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ¼ãƒãƒ¼APIã«é€ä¿¡ã—ã€å¿œç­”ã‚’å¾…ã¤
 * @param {string} userMessage - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
async function sendMessage(userMessage) {
    if (!userMessage.trim()) return;

    displayMessage(userMessage, 'msg-user');
    inputElement.value = '';
    
    // å…¥åŠ›ä¸­ã®UIåˆ¶å¾¡
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'typing msg-bot message';
    typingIndicator.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    messagesContainer.appendChild(typingIndicator);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    try {
        // ã‚µãƒ¼ãƒãƒ¼ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆ/api/chat ã¯ /index.js ã«å¿…è¦ï¼‰
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage }),
        });

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
        if (!response.ok) {
            // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
            const errorText = await response.text();
            throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ${response.status} - ${errorText.substring(0, 50)}...`);
        }

        const data = await response.json();
        const botMessage = data.response || "ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚**index.jsã§/api/chatãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚**";

        // å…¥åŠ›ä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
        messagesContainer.removeChild(typingIndicator);

        // ãƒœãƒƒãƒˆã®å¿œç­”ã‚’ç”»é¢ã«è¡¨ç¤º
        displayMessage(botMessage, 'msg-bot');

    } catch (error) {
        console.error("ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
        if (messagesContainer.contains(typingIndicator)) {
             messagesContainer.removeChild(typingIndicator);
        }
        // æ©Ÿèƒ½æ”¹å–„: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        displayMessage(`æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ï¼ˆ/index.jsï¼‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ã€ã¾ãŸã¯ /api/chat ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£ã—ãå¿œç­”ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ (è©³ç´°: ${error.message.substring(0, 50)})`, 'msg-bot');
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
composerForm.addEventListener('submit', (e) => {
    e.preventDefault();
    sendMessage(inputElement.value);
});


// ===================================
// 3. ãã®ä»–ã®UIã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç† (æ©Ÿèƒ½æ”¹å–„: Enterã‚­ãƒ¼å‡¦ç†ã®å®‰å®šåŒ–)
// ===================================

// Enterã‚­ãƒ¼ã§ã®é€ä¿¡ã€Shift+Enterã§ã®æ”¹è¡Œ
inputElement.addEventListener('keydown', (e) => {
    // Enterå˜ä½“ã§ã®é€ä¿¡
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(inputElement.value); // click()ã§ã¯ãªãç›´æ¥sendMessageã‚’å‘¼ã³å‡ºã—
    }
    // Shift+Enterã§ã®æ”¹è¡Œã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨±å¯ï¼ˆe.preventDefault()ãªã—ï¼‰
});

// ãƒãƒ£ãƒƒãƒˆã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
clearButton.addEventListener('click', () => {
    if (confirm("æœ¬å½“ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) {
        messagesContainer.innerHTML = '';
        displayMessage("å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚æ–°ã—ã„ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚", 'msg-bot'); // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    }
});

// æ©Ÿèƒ½æ”¹å–„: åˆæœŸã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’localStorageã§åˆ¶å¾¡
document.addEventListener('DOMContentLoaded', () => {
    const hasVisited = localStorage.getItem('chatVisited');
    if (!hasVisited) {
        displayMessage("ã‚ˆã†ã“ãï¼è‡ªä½œJSAIã¸ã€‚ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚**ï¼ˆã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åˆå›ã®ã¿è¡¨ç¤ºï¼‰**", 'msg-bot');
        localStorage.setItem('chatVisited', 'true');
    } else if (messagesContainer.children.length === 0) {
        displayMessage("æº–å‚™å®Œäº†ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 'msg-bot');
    }
});
</script>
</body>
</html>
